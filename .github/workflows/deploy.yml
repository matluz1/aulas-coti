name: ğŸš€ Deploy .NET API

on:
  push:
    branches:
      - main # Alterar para o branch correto

jobs:
  # Job 1: CompilaÃ§Ã£o
  compilacao:
    name: ğŸ”§ Compilar AplicaÃ§Ã£o
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ”§ Configurar .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: ğŸ“¦ Restaurar dependÃªncias
        run: dotnet restore > relatorio-compilacao.txt

      - name: ğŸ—ï¸ Compilar o projeto
        run: dotnet build --configuration Release --no-restore >> relatorio-compilacao.txt

      - name: â¬†ï¸ Upload do build
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: ./projetos/ProductsApp/

      - name: ğŸ“„ Salvar RelatÃ³rio de CompilaÃ§Ã£o
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-compilacao
          path: relatorio-compilacao.txt

  # Job 2: Testes
  testes:
    name: âœ… Executar Testes
    runs-on: ubuntu-latest
    needs: compilacao # SÃ³ roda depois da compilaÃ§Ã£o

    steps:
      - name: ğŸ“¥ Baixar artefatos do build
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: ./projetos/ProductsApp/

      - name: ğŸ§ª Rodar testes
        run: dotnet test --configuration Release --no-build --verbosity normal > relatorio-testes.txt

      - name: ğŸ“„ Salvar RelatÃ³rio de Testes
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-testes
          path: relatorio-testes.txt

  # Job 3: Deploy
  deploy:
    name: ğŸš€ Publicar AplicaÃ§Ã£o
    runs-on: ubuntu-latest
    needs: [compilacao, testes] # SÃ³ executa se build e testes passarem

    steps:
      - name: ğŸ“¥ Baixar artefatos do build
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: ./projetos/ProductsApp/

      - name: ğŸ“¦ Publicar o artefato
        run: dotnet publish -c Release -o ./projetos/ProductsApp/publish > relatorio-deploy.txt

      - name: â¬†ï¸ Upload do artefato final
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: ./projetos/ProductsApp/publish

      - name: ğŸ“„ Salvar RelatÃ³rio de Deploy
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-deploy
          path: relatorio-deploy.txt
