name: üöÄ Deploy .NET API

on:
  push:
    branches:
      - main # Alterar para o branch correto

jobs:
  # Job 1: Compila√ß√£o
  compilacao:
    name: üîß Compilar Aplica√ß√£o
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üîß Configurar .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: üì¶ Restaurar depend√™ncias
        run: dotnet restore projetos/ProductsApp/ > projetos/ProductsApp/relatorio-compilacao.txt

      - name: üè∑Ô∏è Compilar o projeto
        run: dotnet build --configuration Release --no-restore projetos/ProductsApp/ >> projetos/ProductsApp/relatorio-compilacao.txt

      - name: ‚¨ÜÔ∏è Upload do build
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: projetos/ProductsApp/

      - name: üìÑ Salvar Relat√≥rio de Compila√ß√£o
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-compilacao
          path: projetos/ProductsApp/relatorio-compilacao.txt

  # Job 2: Testes
  testes:
    name: ‚úÖ Executar Testes
    runs-on: ubuntu-latest
    needs: compilacao # S√≥ roda depois da compila√ß√£o

    steps:
      - name: üì• Baixar artefatos do build
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: projetos/ProductsApp/

      - name: üß© Rodar testes
        run: dotnet test --configuration Release --no-build --verbosity normal projetos/ProductsApp/ > projetos/ProductsApp/relatorio-testes.txt

      - name: üìÑ Salvar Relat√≥rio de Testes
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-testes
          path: projetos/ProductsApp/relatorio-testes.txt

  # Job 3: Deploy
  deploy:
    name: üöÄ Publicar Aplica√ß√£o
    runs-on: ubuntu-latest
    needs: [compilacao, testes] # S√≥ executa se build e testes passarem

    steps:
      - name: üì• Baixar artefatos do build
        uses: actions/download-artifact@v4
        with:
          name: build-output
          path: projetos/ProductsApp/

      - name: üì¶ Publicar o artefato
        run: dotnet publish -c Release -o projetos/ProductsApp/publish projetos/ProductsApp/ > projetos/ProductsApp/relatorio-deploy.txt

      - name: ‚¨ÜÔ∏è Upload do artefato final
        uses: actions/upload-artifact@v4
        with:
          name: app
          path: projetos/ProductsApp/publish

      - name: üìÑ Salvar Relat√≥rio de Deploy
        uses: actions/upload-artifact@v4
        with:
          name: relatorio-deploy
          path: projetos/ProductsApp/relatorio-deploy.txt
